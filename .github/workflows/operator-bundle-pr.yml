name: Operator Bundle PR

on:
  workflow_dispatch:
    inputs:
      operator-version:
        description: "Operator version for bundle generation"
        required: true
        default: "0.0.0"
      submit-to-redhat:
        description: "Submit bundle to RedHat certified-operators repo"
        required: false
        type: boolean
        default: false

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  bundle:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Install operator-sdk
        run: |
          # renovate: datasource=github-tags depName=operator-framework/operator-sdk
          OPERATOR_SDK_VERSION="v1.42.0"

          # Remove any existing installation
          sudo rm -f /usr/local/bin/operator-sdk

          # Download with redirect following and fail on error
          curl -sSL --fail -o /tmp/operator-sdk "https://github.com/operator-framework/operator-sdk/releases/download/${OPERATOR_SDK_VERSION}/operator-sdk_linux_amd64"

          # Verify it's a binary, not HTML/text
          file /tmp/operator-sdk

          # Make executable and move to PATH
          chmod +x /tmp/operator-sdk
          sudo mv /tmp/operator-sdk /usr/local/bin/operator-sdk

          # Verify installation
          operator-sdk version

      - name: Generate Bundle
        working-directory: operators
        run: |
          make bundle-release VERSION=${{ inputs.operator-version }}

      - name: Checkout certified-operators repo
        if: ${{ inputs.submit-to-redhat }}
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.NGINX_PAT }}
          repository: nginx-bot/certified-operators
          path: certified-operators

      - name: Sync fork with upstream
        if: ${{ inputs.submit-to-redhat }}
        working-directory: certified-operators
        run: |
          git remote add upstream https://github.com/redhat-openshift-ecosystem/certified-operators.git
          git fetch upstream
          git checkout main
          git merge upstream/main --ff-only
          git push origin main

      - name: Update certified-operators repo
        if: ${{ inputs.submit-to-redhat }}
        working-directory: certified-operators/operators/nginx-gateway-fabric-operator
        run: |
          mkdir v${{ inputs.operator-version }}
          cp -R ${{ github.workspace }}/operators/bundle/manifests v${{ inputs.operator-version }}/
          cp -R ${{ github.workspace }}/operators/bundle/metadata v${{ inputs.operator-version }}/

      - name: Commit and push to certified-operators
        if: ${{ inputs.submit-to-redhat }}
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: operator nginx-gateway-fabric-operator (v${{ inputs.operator-version }})
          commit_author: nginx-bot <integrations@nginx.com>
          commit_user_name: nginx-bot
          commit_user_email: integrations@nginx.com
          create_branch: true
          branch: update-nginx-gateway-fabric-operator-to-v${{ inputs.operator-version }}
          repository: certified-operators

      - name: Create PR to RedHat certified-operators
        if: ${{ inputs.submit-to-redhat }}
        working-directory: certified-operators
        run: |
          gh pr create --title "operator nginx-gateway-fabric-operator (v${{ inputs.operator-version }})" --body "Update nginx-gateway-fabric-operator to v${{ inputs.operator-version }}" --head nginx-bot:update-nginx-gateway-fabric-operator-to-v${{ inputs.operator-version }} --base main --repo redhat-openshift-ecosystem/certified-operators
        env:
          GITHUB_TOKEN: ${{ secrets.NGINX_PAT }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Generate operator bundle for v${{ inputs.operator-version }}
          title: Operator Bundle v${{ inputs.operator-version }}
          draft: true
          delete-branch: true
          branch: operator/bundle-${{ inputs.operator-version }}
          author: nginx-bot <integrations@nginx.com>
          base: main
          committer: nginx-bot <integrations@nginx.com>
          labels: needs cherry pick
          add-paths: operators/**
          body: |
            This automated PR generates the operator bundle for v${{ inputs.operator-version }}.

            ## What's Changed
            - Updated NGF image versions in sample manifests using image digests
            - Generated bundle manifests and metadata
            - Updated ClusterServiceVersion with proper annotations and descriptors
            - Added OpenShift compatibility annotations
