apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cafe-routes
spec:
  parentRefs:
    - name: auth-gateway
  rules:
    - matches:
        # Coffee with Basic Auth via basic-auth1
        - path:
            type: PathPrefix
            value: /coffee1
        # Additional coffee path with same auth
        - path:
            type: PathPrefix
            value: /coffee2
      backendRefs:
        - name: coffee
          port: 80
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.nginx.org
            kind: AuthenticationFilter
            name: basic-auth1
    # Tea with Basic Auth via basic-auth2
    - matches:
        - path:
            type: PathPrefix
            value: /tea
      backendRefs:
        - name: tea
          port: 80
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.nginx.org
            kind: AuthenticationFilter
            name: basic-auth2
    # Latte without authentication
    - matches:
        - path:
            type: PathPrefix
            value: /latte
      backendRefs:
        - name: latte
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: grpc-route
spec:
  parentRefs:
    - name: auth-gateway
      sectionName: http
  rules:
    - matches:
        - method:
            service: helloworld.Greeter
            method: SayHello
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.nginx.org
            kind: AuthenticationFilter
            name: basic-auth-grpc
      backendRefs:
        - name: grpc-backend
          port: 8080
---
# Basic Auth Secret and AuthenticationFilter
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth1
type: nginx.org/htpasswd
data:
  # Base64 of "htpasswd -bn user1 password1"
  auth: dXNlcjE6JGFwcjEkWEFKeU5yekgkY0Rjdy9YMVBCZTFmTjltQVBweXpxMA==
---
apiVersion: gateway.nginx.org/v1alpha1
kind: AuthenticationFilter
metadata:
  name: basic-auth1
spec:
  type: Basic
  basic:
    secretRef:
      name: basic-auth1
    realm: "Restricted basic-auth1"
---
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth2
type: nginx.org/htpasswd
data:
  # Base64 of "htpasswd -bn user2 password2"
  auth: dXNlcjI6JGFwcjEkd0lKUUpjZEUkSXUuYjVhMlBGODdtQi5zT0x4aUg5MQ==
---
apiVersion: gateway.nginx.org/v1alpha1
kind: AuthenticationFilter
metadata:
  name: basic-auth2
spec:
  type: Basic
  basic:
    secretRef:
      name: basic-auth2
    realm: "Restricted basic-auth2"
---
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth-grpc
type: nginx.org/htpasswd
data:
  # Base64 of "htpasswd -bn user2 password2"
  auth: dXNlcjI6JGFwcjEkd0lKUUpjZEUkSXUuYjVhMlBGODdtQi5zT0x4aUg5MQ==
---
apiVersion: gateway.nginx.org/v1alpha1
kind: AuthenticationFilter
metadata:
  name: basic-auth-grpc
spec:
  type: Basic
  basic:
    secretRef:
      name: basic-auth-grpc
    realm: "Restricted basic-auth-grpc"
